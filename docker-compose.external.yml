version: '3.8'

# ============================================================================
# Codebase State Manager - Docker Compose (Neo4j Externo)
#
# Use este arquivo quando preferir Neo4j em container SEPARADO
# Mais adequado para produção ou quando Neo4j é compartilhado
#
# Para usar:
#   docker-compose -f docker-compose.external.yml up
# ============================================================================

services:
  # ==========================================================================
  # Neo4j Service (separado)
  # ==========================================================================
  neo4j:
    image: neo4j:5.24
    container_name: codebase-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_PLUGINS: ["apoc", "graph-data-science"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('neo4j',7687)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # MCP Server App (conecta ao Neo4j externo)
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: codebase-state-manager
    ports:
      - "8080:8080"
    environment:
      # Desabilita Neo4j interno
      NEO4J_ENABLED: "false"
      
      # Conecta ao Neo4j externo
      DB_MODE: "neo4j"
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "password"
      
      DOCKER_VOLUME_NAME: "codebase_state_data"
    volumes:
      - codebase_data:/app/data
    depends_on:
      neo4j:
        condition: service_healthy
    restart: unless-stopped

# ============================================================================
# Volumes
# ============================================================================
volumes:
  neo4j_data:
  neo4j_logs:
  codebase_data:

networks:
  default:
    name: codebase-network
    driver: bridge
